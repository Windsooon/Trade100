# 需求文档 (Requirements Document)

## 项目概述 (Project Overview)

Polymarket 现有的 dashboard 功能较为基础，用户无法全面查看和分析自己的交易记录。本项目旨在开发一个强大的交易分析工具，帮助用户：

1. **查看完整的交易记录**：按时间、市场、类型等维度筛选和浏览
2. **进行深度分析**：包括收益/损失统计、交易行为分析、市场对比等
3. **市场级分析**：不仅显示用户自己的交易，还整合市场整体数据，进行对比分析

该工具将增强现有的 Portfolio 页面功能，并可能创建新的分析页面，为用户提供比 Polymarket 官方 dashboard 更强大的交易分析能力。

## 用户故事 (User Stories)

### P0 - 必须实现 (Must Have)

<!-- markdownlint-disable MD033 -->
| ID | 用户故事 | 验收标准 |
| :--- | :--- | :--- |
| US-001 | 作为交易者，我想要查看我的所有交易记录列表，以便于了解我的完整交易历史 | - 能够显示所有历史交易记录（买入/卖出）<br>- 支持按时间范围筛选（全部/最近30天/90天/1年/自定义）<br>- 支持按市场/事件筛选<br>- 支持按交易类型筛选（买入/卖出）<br>- 支持按时间、金额、市场名称排序<br>- 每条记录显示：时间、市场名称、交易类型、数量、价格、总金额、交易哈希 |
| US-002 | 作为交易者，我想要查看每个市场的交易汇总和盈亏情况，以便于了解我在不同市场的表现 | - 能够按市场分组显示所有交易<br>- 每个市场显示：总买入量、总卖出量、当前持仓、已实现盈亏、未实现盈亏、总盈亏<br>- 支持按盈亏金额、盈亏百分比、交易次数排序<br>- 能够点击进入查看该市场的详细交易记录 |
| US-003 | 作为交易者，我想要在查看市场分析时同时看到市场整体数据和我的交易数据，以便于对比我的表现与市场表现 | - 市场级分析页面显示两部分数据：<br>  - **我的交易数据**：我的交易次数、我的交易量、我的平均买入/卖出价格、我的盈亏<br>  - **市场整体数据**：市场总交易量、市场总交易次数、市场当前价格、市场24h/7d/30d价格变化、市场流动性<br>- 能够对比我的平均买入价格与市场平均价格<br>- 能够对比我的交易时机与市场价格趋势 |
| US-004 | 作为交易者，我想要查看我的总体收益统计，以便于了解我的整体交易表现 | - 显示总体盈亏金额（已实现 + 未实现）<br>- 显示已实现盈亏和未实现盈亏分别统计<br>- 显示总交易次数、总交易量<br>- 显示盈利交易数量和亏损交易数量<br>- 支持按时间段查看（日/周/月） |
| US-011 | 作为交易者，我想要添加和管理多个钱包地址，以便于查看所有地址的聚合交易数据 | - 能够添加多个钱包地址（Ethereum地址格式验证）<br>- 能够为每个地址设置别名/标签<br>- 能够启用/禁用特定地址的分析<br>- 能够删除已添加的地址<br>- 聚合分析显示所有启用地址的合并数据 |
| US-012 | 作为交易者，我想要配置数据更新方式，以便于控制数据刷新频率和节省资源 | - 默认启用实时更新（每10秒自动刷新）<br>- 能够在设置中关闭实时更新<br>- 关闭实时更新后，提供手动刷新按钮<br>- 实时更新时显示刷新状态指示器<br>- 设置持久化保存（本地存储） |

### P1 - 重要 (Important)

| ID | 用户故事 | 验收标准 |
| :--- | :--- | :--- |
| US-005 | 作为交易者，我想要查看按时间维度的收益趋势，以便于了解我的交易表现随时间的变化 | - 能够按日/周/月查看收益曲线图<br>- 图表显示累计盈亏和单日/周/月盈亏<br>- 支持切换时间范围（7天/30天/90天/全部）<br>- 图表支持交互（悬停显示详细数据） |
| US-006 | 作为交易者，我想要查看我的交易行为分析，以便于了解我的交易习惯和模式 | - 显示交易频率统计（每日/每周交易次数）<br>- 显示平均持仓时间<br>- 显示买卖比例（买入次数 vs 卖出次数）<br>- 显示胜率（盈利交易占比）<br>- 显示平均盈利和平均亏损金额 |
| US-007 | 作为交易者，我想要查看每个市场的详细交易时间线，以便于了解我在该市场的完整交易过程 | - 显示该市场所有交易的时间线视图<br>- 时间线显示每次交易的：时间、类型（买入/卖出）、数量、价格、累计持仓、累计盈亏<br>- 能够看到持仓变化曲线<br>- 能够看到价格变化曲线（市场价 vs 我的交易价） |

### P2 - 可选 (Nice to Have)

| ID | 用户故事 | 验收标准 |
| :--- | :--- | :--- |
| US-008 | 作为交易者，我想要通过高级图表可视化我的交易数据，以便于更直观地理解我的交易模式 | - 收益曲线图（累计和单期）<br>- 交易分布热力图（按市场、按时间）<br>- 盈亏分布直方图<br>- 市场表现对比雷达图 |
| US-009 | 作为交易者，我想要导出我的交易记录和分析报告，以便于进行外部分析或记录保存 | - 支持导出交易记录为 CSV 格式<br>- 支持导出分析报告为 PDF 格式<br>- CSV 包含所有交易字段<br>- PDF 包含关键统计数据和图表 |
| US-010 | 作为交易者，我想要获得基于历史数据的交易策略建议，以便于改进我的交易决策 | - 分析我的交易模式（如：是否过早卖出盈利交易、是否持有亏损交易过久）<br>- 提供简单的建议（如：平均持仓时间建议、止损建议）<br>- 显示我在不同市场类型的表现对比（如：政治事件 vs 体育事件） |

## 范围定义 (Scope)

### 包含 (In Scope)

- **交易记录查看功能**：
  - 完整的交易历史列表
  - 多维度筛选和排序
  - 交易详情查看

- **市场级分析功能**：
  - 按市场分组的交易汇总
  - 每个市场的盈亏统计
  - **市场整体数据整合**（交易量、价格趋势、流动性等）
  - **用户交易数据与市场数据的对比分析**

- **收益统计分析**：
  - 总体盈亏统计
  - 已实现/未实现盈亏分离
  - 按时间段（日/周/月）的收益趋势

- **交易行为分析**：
  - 交易频率、持仓时间、买卖比例
  - 胜率统计
  - 平均盈亏分析

- **数据可视化**：
  - 收益趋势图表
  - 交易时间线视图
  - 市场对比图表

- **多钱包管理功能**：
  - 支持添加/删除多个钱包地址
  - 多地址聚合分析
  - 地址别名管理

- **数据更新配置**：
  - 实时自动更新（默认每10秒）
  - 手动刷新模式
  - 更新状态指示

- **高级功能**（P2）：
  - 高级图表（热力图、雷达图等）
  - 数据导出（CSV/PDF）
  - 交易策略建议

### 排除 (Out of Scope)

- **实时交易功能**：不包含执行交易的功能，只做分析和查看
- **社交功能**：不包含与其他用户分享或对比的功能
- **预测功能**：不包含基于AI的价格预测或交易建议（P2的策略建议是简单的模式分析，不是预测）
- **移动端优化**：本次主要针对桌面端，移动端体验优化不在本次范围
- **数据持久化**：不包含将数据保存到本地数据库的功能（数据从API实时获取）

## 非功能性需求 (Non-Functional Requirements)

| 类别 | 要求 |
| :--- | :--- |
| 性能 | - 交易记录列表加载时间 < 2秒<br>- 图表渲染时间 < 1秒<br>- 支持分页加载，每页最多显示100条记录<br>- API响应时间 < 3秒 |
| 安全 | - 钱包地址验证（Ethereum地址格式）<br>- API请求使用HTTPS<br>- 不存储敏感交易数据在客户端 |
| 兼容性 | - 支持 Chrome、Firefox、Safari 最新版本<br>- 响应式设计，支持桌面端（1920x1080及以上）<br>- 支持暗色/亮色主题切换 |
| 可用性 | - 界面清晰直观，符合现有设计系统<br>- 提供加载状态和错误提示<br>- 支持键盘导航<br>- 关键操作有确认提示 |
| 数据准确性 | - 交易数据与Polymarket API保持一致<br>- 盈亏计算准确（考虑已实现/未实现）<br>- 时间显示准确（考虑时区） |

## 技术实现要点 (Technical Implementation Notes)

### API 抽象层设计（关键架构要求）

**重要**：本项目使用 Dome API 作为数据源，但**必须实现API抽象层**，不直接调用 Dome API。这样设计的原因：

1. **可维护性**：未来可能更换API供应商，抽象层使得切换成本最小
2. **可测试性**：抽象层便于mock和单元测试
3. **统一接口**：不同API供应商可能有不同的响应格式，抽象层统一数据模型

**实现要求**：
- 创建统一的接口定义（Interface/Type）
- 实现 Dome API 适配器（Adapter Pattern）
- 所有业务代码只依赖抽象接口，不直接依赖 Dome API
- 抽象层位置：`src/lib/api/` 或 `src/services/api/`

**示例结构**：
```
src/lib/api/
  ├── interfaces/
  │   ├── trade-history.interface.ts    # 交易历史接口定义
  │   ├── activity.interface.ts         # 活动记录接口定义
  │   └── market-data.interface.ts      # 市场数据接口定义
  ├── adapters/
  │   └── dome-api.adapter.ts           # Dome API 适配器实现
  └── api-client.ts                     # 统一的API客户端
```

### 数据源

1. **用户交易数据**（通过抽象层）：
   - **Trade History API**: 获取用户交易历史
     - 支持按用户地址、市场、时间范围筛选
     - 支持分页（limit/offset）
     - 参考：[Dome API Trade History](https://docs.domeapi.io/api-reference/endpoint/get-trade-history)
   - **Activity API**: 获取用户活动记录（包括 MERGES, SPLITS, REDEEMS）
     - 支持按用户地址、市场、时间范围筛选
     - 支持分页（limit/offset）
     - 参考：[Dome API Activity](https://docs.domeapi.io/api-reference/endpoint/get-activity)
   - 现有端点（保留兼容）：
     - `/api/portfolio/activity` - 用户活动记录
     - `/api/user-positions-history` - 用户持仓历史

2. **市场整体数据**：
   - `/api/markets` - 市场列表和基本信息
   - `/api/prices-history?market={conditionId}` - 市场价格历史
   - `/api/trades?market={conditionId}` - 市场交易记录（不含user参数）
   - 通过抽象层获取市场统计数据

### 关键计算

- **已实现盈亏**：已卖出部分的盈亏 = (卖出价格 - 平均买入价格) × 卖出数量
- **未实现盈亏**：当前持仓的盈亏 = (当前价格 - 平均买入价格) × 当前持仓
- **平均持仓时间**：所有已平仓交易的持仓时间平均值
- **胜率**：盈利交易数 / 总交易数

### 实时更新机制

- **默认行为**：每10秒自动刷新数据
- **配置选项**：用户可在设置中关闭自动更新
- **手动刷新**：关闭自动更新后，提供手动刷新按钮
- **实现方式**：
  - 使用 React Query 的 `refetchInterval` 实现自动刷新
  - 刷新状态通过 loading indicator 显示
  - 配置保存在 localStorage

### 多钱包聚合分析

- **数据聚合**：多个钱包地址的交易数据需要合并计算
- **聚合维度**：
  - 总体盈亏 = 所有地址盈亏之和
  - 交易次数 = 所有地址交易次数之和
  - 按市场分组时，合并同一市场在不同地址的交易
- **性能考虑**：多地址查询需要并行请求，注意API限流

### UI/UX 考虑

- 复用现有的 Portfolio 页面组件和样式
- 使用现有的图表组件（recharts）
- 遵循现有的设计系统（shadcn/ui）
- 考虑与现有 Activity 页面的整合
- 钱包管理界面：简洁的地址列表，支持添加/删除/启用/禁用

## 开放问题 (Open Questions) - 已解答

- [x] **是否需要支持多个钱包地址的聚合分析？**  
  ✅ **已确认：需要支持**。一个用户可能有多个地址，需要支持多地址聚合分析。

- [x] **数据刷新频率：是否需要实时更新，还是用户手动刷新？**  
  ✅ **已确认：实时更新，每10秒刷新一次**。用户可在设置中关闭实时更新，改为手动刷新模式。

- [x] **历史数据范围：API 是否提供完整的交易历史，还是有限制？**  
  ✅ **已确认：使用 Dome API**。Dome API 的 Trade History 和 Activity API 支持完整的历史数据查询，通过分页（limit/offset）可以获取所有历史记录。**关键要求：必须实现API抽象层，不直接使用Dome API，方便未来更换API供应商。**

- [x] **市场数据对比：是否需要显示我在市场中的排名？**  
  ✅ **已确认：不需要**。市场级分析只显示我的数据与市场整体数据的对比，不显示排名。

- [x] **性能优化：对于交易记录很多的用户，是否需要虚拟滚动？**  
  ✅ **已确认：暂时不需要**。使用分页加载即可，每页最多100条记录。

## 依赖关系 (Dependencies)

- **Dome API**：作为主要数据源
  - Trade History API: `https://api.domeapi.io/v1/polymarket/orders`
  - Activity API: `https://api.domeapi.io/v1/polymarket/activity`
  - 需要 API Key（待确认是否需要）
- **现有 API 端点**：保持兼容，逐步迁移到抽象层
- **现有组件库**：shadcn/ui, recharts 的可用性
- **React Query**：用于数据获取、缓存和自动刷新

## 验收测试场景 (Acceptance Test Scenarios)

### 场景1：查看交易记录
1. 用户进入交易分析页面
2. 系统加载并显示所有交易记录
3. 用户按"最近30天"筛选
4. 系统只显示最近30天的交易
5. 用户按"市场名称"排序
6. 系统按市场名称排序显示

### 场景2：市场级分析
1. 用户进入市场分析视图
2. 系统显示所有有交易的市场列表
3. 用户点击某个市场
4. 系统显示：
   - 我的交易数据（交易次数、交易量、盈亏）
   - 市场整体数据（总交易量、价格趋势、流动性）
   - 对比分析（我的平均价格 vs 市场平均价格）

### 场景3：收益趋势查看
1. 用户进入收益分析页面
2. 系统显示收益趋势图表（默认按日）
3. 用户切换到"按周"视图
4. 系统重新计算并显示按周的收益数据
5. 用户悬停在图表上的某个点
6. 系统显示该时间点的详细数据（日期、盈亏金额）

### 场景4：多钱包管理
1. 用户进入设置页面
2. 用户添加第一个钱包地址
3. 系统验证地址格式并保存
4. 用户添加第二个钱包地址并设置别名"主钱包"
5. 用户返回交易分析页面
6. 系统显示两个地址的聚合交易数据
7. 用户可以在设置中禁用某个地址
8. 系统只显示启用地址的聚合数据

### 场景5：实时更新配置
1. 用户进入交易分析页面（默认实时更新开启）
2. 系统每10秒自动刷新数据，显示刷新指示器
3. 用户进入设置，关闭"实时更新"
4. 系统停止自动刷新，显示手动刷新按钮
5. 用户点击手动刷新按钮
6. 系统刷新数据并显示最新结果
